@using Blazor.Heroicons
@using Blazor.Heroicons.Outline

@inherits LayoutComponentBase
@inject AppBarTitleService TitleService
@inject ILogger<MainLayout> Logger
@inject IJSRuntime JS

<div class="relative h-screen w-screen overflow-hidden select-none"
     @onpointerdown="OnPointerDown"
     @onpointerup="OnPointerUp"
     @ontouchstart="OnTouchStart"
     @ontouchend="OnTouchEnd">

    <!-- Drawer -->
    <aside class="@($"absolute left-0 top-0 bg-slate-200 shadow-lg w-64 h-full transform transition-transform duration-300 ease-in-out {(_drawerOpen ? "translate-x-0" : "-translate-x-full")}")">
        <nav class="flex flex-col h-full p-4">
            <ul class="space-y-2">
                <li><a href="/" class="block px-2 py-1 rounded hover:bg-slate-200">Kalendorius</a></li>
                <li><a href="/export" class="block px-2 py-1 rounded hover:bg-slate-200">Exportas</a></li>
            </ul>
        </nav>
    </aside>

    <div class="h-full flex flex-col transition-all duration-300 ease-in-out @(_drawerOpen ? "ml-64" : "ml-0")">
        <header class="relative flex items-center bg-slate-500 text-white p-4 shadow-md">
            <button @onclick="DrawerToggle" class="absolute left-4">
                <Heroicon Name="@HeroiconName.Bars3"
                          Type="HeroiconType.Outline"
                          class="h-6 w-6" />
            </button>
            <h1 class="flex-1 text-center text-4xl font-semibold">@appBarTitle</h1>
        </header>

        <main class="flex-1 overflow-auto">
            @Body
        </main>
    </div>
</div>

<script type="text/javascript">
        window.getHeight = function () {
        return window.innerHeight
    };

    window.getWidth = function () {
        return window.innerWidth;
    };
</script>

@code {
    private bool _drawerOpen = false;
    private string appBarTitle = string.Empty;

    private double _startX;
    private double _startY;
    private const double SwipeThreshold = 50;
    private bool _validSwipeArea = false;
    private double _viewportWidth;
    private double _viewportHeight;

    public MainLayout()
    {

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _viewportHeight = await JS.InvokeAsync<int>("getHeight");
            _viewportWidth = await JS.InvokeAsync<int>("getWidth");
        }
    }

    protected override Task OnInitializedAsync()
    {
        appBarTitle = TitleService.Title;
        TitleService.OnTitleChanged += OnTitleChanged;
        return base.OnInitializedAsync();
    }

    private void OnTitleChanged(string newTitle)
    {
        appBarTitle = newTitle;
        InvokeAsync(StateHasChanged);
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void OnPointerDown(PointerEventArgs e)
    {
        HandleStart(e.ClientX, e.ClientY);
    }

    private void OnTouchStart(TouchEventArgs e)
    {
        if (e.Touches.Length > 0)
            HandleStart(e.Touches[0].ClientX, e.Touches[0].ClientY);
    }

    private void HandleStart(double x, double y)
    {
        _startX = x;
        _startY = y;

        _validSwipeArea = (_startX <= _viewportWidth * 0.3) && (_startY <= _viewportHeight * 0.2);
        Logger.LogInformation("Swipe start X={X}, Y={Y}, valid={Valid}", _startX, _startY, _validSwipeArea);
    }

    private void OnPointerUp(PointerEventArgs e)
    {
        HandleEnd(e.ClientX);
    }

    private void OnTouchEnd(TouchEventArgs e)
    {
        if (e.ChangedTouches.Length > 0)
            HandleEnd(e.ChangedTouches[0].ClientX);
    }

    private void HandleEnd(double endX)
    {
        if (!_validSwipeArea) return;

        var distance = endX - _startX;

        if (distance > SwipeThreshold) _drawerOpen = true;
        else if (distance < -SwipeThreshold) _drawerOpen = false;

        StateHasChanged();
        _validSwipeArea = false;
    }

    public void Dispose()
    {
        TitleService.OnTitleChanged -= OnTitleChanged;
    }
}
