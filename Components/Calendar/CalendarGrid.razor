@namespace WorkJournal.Components.Calendar

@inject ILogger<CalendarGrid> Logger

<div class="w-full max-w-xl p-4 rounded-lg shadow-md">
    <!-- Month / Year Navigation -->
    <div class="flex items-center justify-between mb-4 space-x-4">
        <!-- Previous Month -->
        <button @onclick="PrevMonth" class="p-1 hover:bg-gray-300 rounded">
            <Heroicon Name="@HeroiconName.ChevronLeft"
                      Type="HeroiconType.Outline"
                      class="h-6 w-6" />
        </button>

        <!-- Current Month and Year -->
        <!-- Current Month and Year -->
        <div class="text-2xl font-semibold flex items-center space-x-2">
            <!-- Month Dropdown -->
            <div class="relative">
                <button @onclick="ToggleMonthDropdown"
                        class="flex px-3 py-1 items-center rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition space-x-1">
                    <Heroicon Name="@(_showMonthDropdown? HeroiconName.ChevronUp: HeroiconName.ChevronDown)"
                              Type="HeroiconType.Outline"
                              class="h-6 w-6" />
                    <span>@(char.ToUpper(CurrentDate.ToString("MMMM", lt)[0]) + CurrentDate.ToString("MMMM", lt).Substring(1))</span>
                </button>

                @if (_showMonthDropdown)
                {
                    <ul class="absolute left-0 mt-2 w-36 bg-white border border-gray-200 rounded-md shadow-lg z-999 max-h-60 overflow-auto py-1">
                        @for (int m = 1; m <= 12; m++)
                        {
                            var index = m;
                            var monthName = new DateTime(CurrentDate.Year, m, 1).ToString("MMMM", lt);
                            var capitalizedMonth = char.ToUpper(monthName[0]) + monthName.Substring(1);

                            <li>
                                <button class="w-full text-left px-4 py-2 rounded-md hover:bg-blue-100 hover:text-blue-800 transition
                                               @(index == CurrentDate.Month ? "text-red-500 font-semibold" : "text-black")"
                                        @onclick="() => SelectMonth(index)">
                                    @capitalizedMonth
                                </button>
                            </li>
                        }
                    </ul>
                }
            </div>

            <!-- Year Dropdown -->
            <div class="relative">
                <button @onclick="ToggleYearDropdown"
                        class="flex px-3 py-1 items-center rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition space-x-1">
                    <span>@CurrentDate.Year</span>
                    <Heroicon Name="@(_showYearDropdown? HeroiconName.ChevronUp: HeroiconName.ChevronDown)"
                              Type="HeroiconType.Outline"
                              class="h-6 w-6" />
                </button>

                @if (_showYearDropdown && _years != null)
                {
                    <ul class="absolute left-0 mt-2 w-28 bg-white border border-gray-200 rounded-md shadow-lg z-999 max-h-60 overflow-auto py-1">
                        @foreach (var year in _years)
                        {
                            <li>
                                <button class="w-full text-left px-4 py-2 rounded-md hover:bg-blue-100 hover:text-blue-800 transition
                                               @(year == CurrentDate.Year ? "text-red-500 font-semibold" : "text-black")"
                                        @onclick="() => SelectYear(year)">
                                    @year
                                </button>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>

        <!-- Next Month -->
        <button @onclick="NextMonth" class="p-1 hover:bg-gray-300 rounded">
            <Heroicon Name="@HeroiconName.ChevronRight"
                      Type="HeroiconType.Outline"
                      class="h-6 w-6" />
        </button>
    </div>

    <!-- Day Names -->
    <div class="grid grid-cols-8 font-bold mb-2 text-lg">
        <div></div> <!-- Week select column -->
        @foreach (var dayName in DayNames)
        {
            <div class="truncate text-center">@dayName</div>
        }
    </div>

    <!-- Days -->
    <div class="space-y-2">
        @for (int weekIndex = 0; weekIndex < Weeks.Count; weekIndex++)
        {
            var index = weekIndex;
            var week = Weeks[weekIndex];
            bool isSelected = SelectedWeek != null && SelectedWeek.Intersect(week.Where(d => d.HasValue)).Any();

            <div class="relative grid grid-cols-8 gap-2 items-center">
                <!-- Overlay covering the entire week row -->
                @if (isSelected)
                {
                    <div class="absolute inset-0 bg-indigo-500 opacity-40 z-50 pointer-events-none rounded-lg"></div>
                }

            <!-- Week select button -->
            <button class="relative z-60 shadow-md aspect-square w-full flex items-center justify-center rounded-lg border text-sm font-medium
                   @(isSelected
                                                                   ? "bg-indigo-500 text-white border-indigo-600"
                                                                   : "bg-slate-100 text-slate-900 border-slate-300 hover:bg-slate-200")"
                        @onclick="() => SelectWeek(index)">
                    <Heroicon Name="@HeroiconName.ChevronDoubleRight"
                              Type="HeroiconType.Outline"
                              class="h-6 w-6" />
                </button>

                <!-- Day buttons (render inline inside row) -->
                @foreach (var day in week)
                {
                    if (day.HasValue)
                    {
                        var isToday = day.Value.Date == DateTime.Today;
                        <CalendarDayButton Day="@day.Value.Day" IsToday="@isToday" />
                    }
                    else
                    {
                        <div class="aspect-square w-full"></div>
                    }
                }
            </div>
        }
    </div>
</div>

@code {
    private CultureInfo lt = new CultureInfo("lt-LT");
    private DateTime CurrentDate = DateTime.Today;
    private string[] DayNames = [];
    private List<List<DateTime?>> Weeks = new();

    [Parameter]
    public List<DateTime?> SelectedWeek { get; set; } = new();

    [Parameter]
    public EventCallback<List<DateTime?>> SelectedWeekChanged { get; set; }

    private bool _showMonthDropdown = false;
    private bool _showYearDropdown = false;
    private List<int> _years = Enumerable.Range(DateTime.Today.Year - 10, 21).ToList();

    public CalendarGrid()
    {

    }

    protected override Task OnInitializedAsync()
    {
        DayNames = lt.DateTimeFormat.AbbreviatedDayNames
        .Skip(1)
        .Concat(lt.DateTimeFormat.AbbreviatedDayNames.Take(1))
        .Select(d => char.ToUpper(d[0]) + d.Substring(1))
        .ToArray();

        GenerateCalendar(CurrentDate);

        return base.OnInitializedAsync();
    }

    private void GenerateCalendar(DateTime date)
    {
        Weeks.Clear();

        var firstDayOfMonth = new DateTime(date.Year, date.Month, 1);
        int leadingEmptyCells = ((int)firstDayOfMonth.DayOfWeek + 6) % 7;
        int daysInMonth = DateTime.DaysInMonth(date.Year, date.Month);

        var currentWeek = new List<DateTime?>();

        for (int i = 0; i < leadingEmptyCells; i++)
            currentWeek.Add(null);

        for (int day = 1; day <= daysInMonth; day++)
        {
            currentWeek.Add(new DateTime(date.Year, date.Month, day));

            if (currentWeek.Count == 7)
            {
                Weeks.Add(currentWeek);
                currentWeek = new List<DateTime?>();
            }
        }

        if (currentWeek.Count > 0)
        {
            while (currentWeek.Count < 7)
                currentWeek.Add(null);
            Weeks.Add(currentWeek);
        }
    }

    private async Task SelectWeek(int weekIndex)
    {
        Logger.LogInformation("WeekIndex: {WeekIndex}, Weeks.Count: {WeeksCount}", weekIndex, Weeks.Count);

        if (weekIndex < 0 || weekIndex >= Weeks.Count)
            return;

        SelectedWeek = Weeks[weekIndex].Where(d => d.HasValue).ToList();

        // Notify parent
        await SelectedWeekChanged.InvokeAsync(SelectedWeek);
    }

    // Month navigation
    private void PrevMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        GenerateCalendar(CurrentDate);
    }

    private void NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        GenerateCalendar(CurrentDate);
    }

    private void ToggleMonthDropdown()
    {
        _showMonthDropdown = !_showMonthDropdown;
    }

    // Year dropdown
    private void ToggleYearDropdown()
    {
        _showYearDropdown = !_showYearDropdown;
    }

    private void SelectMonth(int month)
    {
        // Clamp the day to the max day of the new month
        int daysInNewMonth = DateTime.DaysInMonth(CurrentDate.Year, month);
        int day = Math.Min(CurrentDate.Day, daysInNewMonth);

        CurrentDate = new DateTime(CurrentDate.Year, month, day);
        _showMonthDropdown = false;
        GenerateCalendar(CurrentDate);
    }

    private void SelectYear(int year)
    {
        // Clamp the day to the max day of the current month in the new year
        int daysInMonth = DateTime.DaysInMonth(year, CurrentDate.Month);
        int day = Math.Min(CurrentDate.Day, daysInMonth);

        CurrentDate = new DateTime(year, CurrentDate.Month, day);
        _showYearDropdown = false;
        GenerateCalendar(CurrentDate);
    }
}
